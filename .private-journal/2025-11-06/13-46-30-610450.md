---
title: "1:46:30 PM - November 6, 2025"
date: 2025-11-06T18:46:30.610Z
timestamp: 1762454790610
---

## Project Notes

## Architecture Exploration: Image Browser NSFW Gate

### Frontend Framework
- **Not using React/Vue** - This is a **server-rendered HTML application**
- Single HTML template served from `/src/server/template.html`
- Client-side JS is inline in the template (vanilla JavaScript, no framework)
- Content is rendered on the server side

### Environment Variables Configuration
- **Location**: `/Users/wschenk/The-Focus-AI/image-browser/.env`
- Loaded via `dotenv.config()` in `/src/server.ts` (line 11)
- Variables read directly from `process.env` throughout the app
- Key vars: SUPABASE_DB_URL, REPLICATE_API_TOKEN, IMAGES_DIR, IMAGE_BASE_URL, PORT, etc.

### Main Entry Point
- **Server file**: `/src/server.ts` - main Express server
- **Port**: 3000 (configurable via PORT env var)
- **Startup**: `tsx src/server.ts` in development, `node dist/server.js` in production

### Image Gallery/Browser Rendering
- **Template location**: `/src/server/template.html` (8784 bytes)
- **Rendered by**: `renderTemplate()` function in server.ts (lines 139-159)
- HTML structure: masonry layout with images
- Images served from either local `/images` dir or remote R2 bucket

### UI Components & Modals
The template includes:
- **Stats widget** (fixed position, top-right): shows dataset progress
- **Modal dialog**: for stats details (already has modal overlay implementation at lines 28-71)
- **Loading overlay**: shown when searches > 500ms (lines 38-41)
- **Icon buttons**: Google Lens and download buttons on hover

### Key Routes
- `GET /` - search or list images
- `GET /stats` - JSON stats endpoint
- `GET /neighbors/:file_name` - find similar images

### Database
- **PostgreSQL** via Supabase
- Vector embeddings for semantic search
- Table derived from bucket name (e.g., "ffffound_embeddings")
- Schema includes: id, file_name, width, height, embedding, created_at

### Best Locations for NSFW Gate Feature

1. **Environment Variable**: Add to `.env` file (or validate in validate-env.ts)
   - `NSFW_GATE=true` or `NSFW_GATE_ENABLED=true`

2. **Overlay Component**: Add to `/src/server/template.html`
   - Use existing modal pattern (similar to stats modal)
   - Position: fixed, full-screen warning before masonry loads
   - Can be hidden via localStorage after acknowledgment

3. **Server-side Integration**:
   - Read `NSFW_GATE` in `/src/server.ts` (like other env vars)
   - Pass via template replacement (like `{{PAGE_TITLE}}`)
   - Template can conditionally show/hide overlay based on var

4. **Client-side Logic**:
   - Add JavaScript in template (inline scripts section)
   - Check localStorage for user acknowledgment
   - Show modal on first load if enabled
   - Hide after user clicks "I understand"

### Architecture Pattern
This is a **traditional server-rendered app** with:
- Backend: Express + PostgreSQL + Node.js
- Frontend: Server-side HTML generation + vanilla JS
- No React/Vue framework
- Simple, lightweight approach suitable for image gallery

