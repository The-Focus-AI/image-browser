<!DOCTYPE html>
<html>
<head>
  <title>{{PAGE_TITLE}}</title>
  <style>
    body { font-family: sans-serif; margin: 40px; }
    .search-bar { margin-bottom: 20px; }
    .masonry { columns: 5; column-gap: 16px; }
    .masonry-item { break-inside: avoid; margin-bottom: 16px; display: inline-block; width: 100%; }
    .masonry-item img { cursor: pointer; border: 2px solid #eee; border-radius: 8px; transition: border 0.2s; max-width: 100%; height: auto; display: block; }
    .masonry-item img:hover { border: 2px solid #007bff; }
    .image-wrap { position: relative; }
    .overlay-actions { position: absolute; top: 8px; right: 8px; display: flex; gap: 6px; opacity: 0; transition: opacity 0.15s ease-in-out; }
    .image-wrap:hover .overlay-actions { opacity: 1; }
    .icon-btn { width: 28px; height: 28px; border-radius: 6px; background: rgba(0,0,0,0.55); color: #fff; display: grid; place-items: center; text-decoration: none; font-size: 14px; font-weight: 700; line-height: 1; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .icon-btn:hover { background: rgba(0,0,0,0.7); }
    @media (max-width: 1200px) { .masonry { columns: 4; } }
    @media (max-width: 900px) { .masonry { columns: 3; } }
    @media (max-width: 600px) { .masonry { columns: 2; } }

    /* Stats widget */
    .stats-fixed { position: fixed; top: 16px; right: 16px; z-index: 1000; display: none; }
    .stats-button { appearance: none; border: none; background: transparent; padding: 0; cursor: pointer; }
    .stats-circle { width: 44px; height: 44px; border-radius: 50%; display: grid; place-items: center; background: conic-gradient(#e6e6e6 0deg, #e6e6e6 360deg); box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
    .stats-circle-inner { width: 32px; height: 32px; border-radius: 50%; background: #fff; display: grid; place-items: center; font-size: 11px; font-weight: 600; color: #333; }
    .stats-circle-inner small { font-weight: 500; font-size: 10px; color: #666; }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 1001; }
    .modal-content { background: #fff; border-radius: 10px; width: min(92vw, 380px); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; border-bottom: 1px solid #eee; }
    .modal-title { margin: 0; font-size: 15px; font-weight: 700; }
    .modal-close { background: transparent; border: none; font-size: 18px; line-height: 1; cursor: pointer; color: #666; }
    .modal-body { padding: 14px; font-size: 14px; color: #333; }
    .modal-body p { margin: 8px 0; }
    .modal-body code { background: #f6f6f6; padding: 1px 6px; border-radius: 4px; }

    /* Loading overlay for slow searches */
    .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .loading-spinner { width: 48px; height: 48px; border: 4px solid #e6e6e6; border-top-color: #0a84ff; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* NSFW Warning Overlay */
    .nsfw-warning-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 3000; backdrop-filter: blur(8px); }
    .nsfw-warning-content { background: #fff; border-radius: 12px; padding: 40px; max-width: 500px; margin: 0 20px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.4); }
    .nsfw-warning-content h2 { margin: 0 0 20px 0; font-size: 28px; color: #d32f2f; }
    .nsfw-warning-content p { margin: 12px 0; color: #555; line-height: 1.6; font-size: 16px; }
    .nsfw-button { padding: 14px 40px; font-size: 16px; background: #007bff; color: #fff; border: none; border-radius: 8px; cursor: pointer; margin-top: 24px; font-weight: 600; transition: background 0.2s; }
    .nsfw-button:hover { background: #0056b3; }
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  </head>
  <body>
    <!-- Stats widget (hidden by default; shown when stats load) -->
    <div class="stats-fixed" id="statsWidget" aria-hidden="true">
      <button class="stats-button" id="statsButton" title="Dataset status" aria-label="Dataset status" aria-haspopup="dialog">
        <div class="stats-circle" id="statsCircle" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <div class="stats-circle-inner"><span id="statsLabel">0%</span></div>
        </div>
      </button>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="statsModal" role="dialog" aria-modal="true" aria-labelledby="statsModalTitle">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="statsModalTitle">Dataset stats</h3>
          <button class="modal-close" id="statsClose" aria-label="Close">×</button>
        </div>
        <div class="modal-body">
          <p><strong>Total</strong>: <span id="statTotal">0</span></p>
          <p><strong>Encoded</strong>: <span id="statEncoded">0</span></p>
          <p><strong>Pending</strong>: <span id="statUnencoded">0</span></p>
          <p><strong>Progress</strong>: <span id="statPercent">0%</span></p>
          <p>This shows how many images have embeddings stored. Data is fetched from <code>/stats</code>.</p>
        </div>
      </div>
    </div>

    <!-- NSFW Warning Overlay -->
    <div class="nsfw-warning-overlay" id="nsfwWarning" role="dialog" aria-modal="true" aria-labelledby="nsfwTitle">
      <div class="nsfw-warning-content">
        <h2 id="nsfwTitle">⚠️ Content Warning</h2>
        <p><strong>These are unfiltered images from the internet.</strong></p>
        <p>This collection may contain adult or explicit content not suitable for all audiences.</p>
        <p>Children are discouraged from viewing.</p>
        <button id="nsfwAcknowledge" class="nsfw-button">I Understand</button>
      </div>
    </div>

    <form class="search-bar" method="get" action="/">
      <input type="text" name="q" value="{{QUERY_VALUE}}" placeholder="Search for images..." style="width: 300px; padding: 8px; font-size: 16px;" />
      <button type="submit" style="padding: 8px 16px; font-size: 16px;">Search</button>
    </form>

    <!-- Loading overlay shown if search takes > 500ms -->
    <div class="loading-overlay" id="loadingOverlay" aria-hidden="true" aria-live="polite">
      <div class="loading-spinner" role="status" aria-label="Loading"></div>
    </div>

    <div class="masonry">
      {{IMAGES_HTML}}
    </div>

    <script>
      (function() {
        const widget = document.getElementById('statsWidget');
        const circle = document.getElementById('statsCircle');
        const label = document.getElementById('statsLabel');
        const modal = document.getElementById('statsModal');
        const btn = document.getElementById('statsButton');
        const close = document.getElementById('statsClose');
        const elTotal = document.getElementById('statTotal');
        const elEncoded = document.getElementById('statEncoded');
        const elUnencoded = document.getElementById('statUnencoded');
        const elPercent = document.getElementById('statPercent');

        function setProgress(encoded, total) {
          const pct = total > 0 ? Math.round((encoded / total) * 100) : 0;
          const angle = Math.min(360, Math.max(0, Math.round(3.6 * pct)));
          circle.style.background = 'conic-gradient(#0a84ff ' + angle + 'deg, #e6e6e6 0deg)';
          circle.setAttribute('aria-valuenow', String(pct));
          label.textContent = pct + '%';
          elTotal.textContent = String(total);
          elEncoded.textContent = String(encoded);
          elUnencoded.textContent = String(Math.max(0, total - encoded));
          elPercent.textContent = pct + '%';
        }

        function show(el, on) { el.style.display = on ? 'flex' : 'none'; }

        async function loadStats() {
          try {
            const res = await fetch('/stats', { headers: { 'accept': 'application/json' } });
            if (!res.ok) throw new Error('stats not available');
            const data = await res.json();
            const total = Number(data.total || 0);
            const encoded = Number(data.encoded || 0);
            setProgress(encoded, total);
            widget.style.display = 'block';
            widget.setAttribute('aria-hidden', 'false');
          } catch (e) {
            widget.style.display = 'none';
            widget.setAttribute('aria-hidden', 'true');
          }
        }

        function openModal() { show(modal, true); }
        function closeModal() { show(modal, false); }

        btn.addEventListener('click', (e) => { e.preventDefault(); openModal(); });
        close.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

        loadStats();
        setInterval(loadStats, 20000);
      })();
    </script>

    <script>
      // Show spinner if search takes longer than 500ms
      (function() {
        const form = document.querySelector('form.search-bar');
        const overlay = document.getElementById('loadingOverlay');
        if (!form || !overlay) return;
        let t = null;
        form.addEventListener('submit', function() {
          t = setTimeout(function() {
            overlay.style.display = 'flex';
            overlay.setAttribute('aria-hidden', 'false');
          }, 500);
        });
        const clear = function() { if (t) { clearTimeout(t); t = null; } };
        window.addEventListener('beforeunload', clear);
        window.addEventListener('pagehide', clear);
      })();
    </script>

    <script>
      // NSFW Gate - Show warning overlay if enabled
      (function() {
        const NSFW_GATE = {{NSFW_GATE}};
        if (!NSFW_GATE) return;

        const overlay = document.getElementById('nsfwWarning');
        const button = document.getElementById('nsfwAcknowledge');

        if (!overlay || !button) return;

        // Check if user has acknowledged before (stored in localStorage)
        const hasAcknowledged = localStorage.getItem('nsfwGateAcknowledged') === 'true';

        if (!hasAcknowledged) {
          overlay.style.display = 'flex';
        }

        // Handle acknowledgment
        button.addEventListener('click', function() {
          localStorage.setItem('nsfwGateAcknowledged', 'true');
          overlay.style.display = 'none';
        });

        // Allow ESC key to close (but don't save acknowledgment)
        window.addEventListener('keydown', function(e) {
          if (e.key === 'Escape' && overlay.style.display === 'flex') {
            overlay.style.display = 'none';
          }
        });
      })();
    </script>

    <footer style="margin-top: 40px; text-align: center; color: #666;">
      made by <a href="https://thefocus.ai" target="_blank" rel="noopener noreferrer">thefocus.ai</a>
    </footer>
  </body>
  </html>


